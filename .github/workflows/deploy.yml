name: Deploy Next.js App

on:
  push:
    branches: ["main"]

env:
  PORT: 3000
  APP_NAME: tylers-website
  HOME: /root
  STAGING_DIR: /root/tylers-website-staging

jobs:
  deploy:
    runs-on: main
    environment: PROD

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build in staging directory
        run: |
          # Create staging directory
          mkdir -p $STAGING_DIR

          # Copy source files to staging (preserve node_modules if exists for faster builds)
          rsync -av --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env' \
            ./ $STAGING_DIR/

          cd $STAGING_DIR

          # Create .env file
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env
          echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env
          echo "S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}" >> .env
          echo "S3_ACCESS_KEY_ID=${{ secrets.S3_ACCESS_KEY_ID }}" >> .env
          echo "S3_SECRET_ACCESS_KEY=${{ secrets.S3_SECRET_ACCESS_KEY }}" >> .env
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> .env
          echo "S3_PUBLIC_URL=${{ secrets.S3_PUBLIC_URL }}" >> .env
          echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env
          echo "SMTP_PORT=${{ secrets.SMTP_PORT }}" >> .env
          echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
          echo "SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}" >> .env
          echo "CONTACT_EMAIL=${{ secrets.CONTACT_EMAIL }}" >> .env
          echo "OPENWEBUI_URL=${{ secrets.OPENWEBUI_URL }}" >> .env
          echo "OPENWEBUI_API_KEY=${{ secrets.OPENWEBUI_API_KEY }}" >> .env
          echo "AI_MODEL=${{ secrets.AI_MODEL }}" >> .env

          # Install dependencies (will reuse existing node_modules)
          npm install
          npx prisma generate
          npm run build

      - name: Deploy with minimal downtime
        run: |
          LIVE_DIR=$(pwd)

          # Sync the built app from staging to live
          rsync -av --delete \
            --exclude '.git' \
            $STAGING_DIR/ $LIVE_DIR/

          # Restart the app
          if pm2 list | grep -q $APP_NAME; then
            pm2 restart $APP_NAME
          else
            pm2 start npm --name $APP_NAME -- start -- --port=$PORT
          fi
          pm2 save
