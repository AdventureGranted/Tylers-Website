name: Deploy Next.js App

on:
  push:
    branches: ["main"]

env:
  PORT: 3000
  APP_NAME: tylers-website
  HOME: /root
  STAGING_DIR: /root/tylers-website-staging

jobs:
  deploy:
    runs-on: main
    environment: PROD

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build in staging directory
        run: |
          # Create staging directory
          mkdir -p $STAGING_DIR

          # Copy source files to staging (preserve node_modules if exists for faster builds)
          rsync -av --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env' \
            ./ $STAGING_DIR/

          cd $STAGING_DIR

          # Create .env file
          cat <<EOF > .env
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}
          S3_ACCESS_KEY_ID=${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY=${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET=${{ secrets.S3_BUCKET }}
          S3_PUBLIC_URL=${{ secrets.S3_PUBLIC_URL }}
          EOF

          # Install dependencies (will reuse existing node_modules)
          npm install
          npx prisma generate
          npm run build

      - name: Deploy with minimal downtime
        run: |
          LIVE_DIR=$(pwd)

          # Sync the built app from staging to live
          rsync -av --delete \
            --exclude '.git' \
            $STAGING_DIR/ $LIVE_DIR/

          # Restart the app
          if pm2 list | grep -q $APP_NAME; then
            pm2 restart $APP_NAME
          else
            pm2 start npm --name $APP_NAME -- start -- --port=$PORT
          fi
          pm2 save
